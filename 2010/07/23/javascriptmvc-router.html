<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1">
<meta name="author" content="Thomas Reynolds">
<!-- Mobile viewport optimization http://goo.gl/b9SaQ --><meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Mobile IE allows us to activate ClearType technology for smoothing fonts for easy reading --><meta http-equiv="cleartype" content="on">
<!-- Google Setup --><meta content="VbyiHsqFIT6NSIBRNw/TAnm+9zy0TAmFRiC68lYCoSw=" name="verify-v1">
<!-- OpenID Setup --><link href="http://www.myopenid.com/server" rel="openid.server">
<link href="http://tdreyno.myopenid.com/" rel="openid.delegate">
<link href="http://tdreyno.myopenid.com" rel="openid2.local_id">
<link href="http://www.myopenid.com/server" rel="openid2.provider">
<meta content="http://www.myopenid.com/xrds?username=tdreyno.myopenid.com" http-equiv="X-XRDS-Location">
<title>JavascriptMVC Router Â« Thomas Reynolds</title>
<!-- Stylesheet --><link type="text/css" href="/stylesheets/new.css?1324795507" rel="stylesheet" media="screen">
<!-- RSS --><link href="http://feeds2.feedburner.com/awf-allposts" rel="alternate" title="Award Winning Fjords" type="application/rss+xml">
</head>
<body>
    <header><h1>
        <a href="/">Award-Winning Fjords</a>
        <span class="small">Thomas Reynolds</span>
      </h1></header><div id="frame">
      
        <article><h2>JavascriptMVC Router</h2>
          <time>Jul 23 2010</time><p><strong>[Edit]: The SecondStoryJS Router now has a documentation website at <a href="http://secondstory.github.com/secondstoryjs-router/">http://secondstory.github.com/secondstoryjs-router/</a></strong></p>

<p>Modern web applications should function as naturally as their static page-based predecessors. As developers, we may need to store state in the location bar, but the user shouldn't be able to tell the difference, except, hopefully, the Ajaxified version should be faster and smoother.</p>

<p>To accomplish this, we need to move a lot of the libraries we've used on the backend into the world of Javascript. JavascriptMVC handles models, views and controllers, but it doesn't provide a router. A router takes a string which contains state, such as <tt>/articles/my-first-article</tt> and activates a specific piece of code which can respond to the request.</p>

<p>At <a href="http://secondstory.com/">Secondstory</a>, we've been building upon JavascriptMVC and <a href="http://github.com/joshbuddy/sherpa">Joshua Hull's wonderful Sherpa route recognizer</a>. Originally intended for usage in a NodeJS environment, Sherpa can take complex route definitions (as seen in Ruby on Rails) and map them to a destination while extracting variables from the route.</p>

<p>Here's a matching example from the Sherpa docs:</p>

<div class="highlight">
<pre><span class="nx">Router</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">'/test/:variable'</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="s1">'testing'</span><span class="p">)</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">recognize</span><span class="p">(</span><span class="s1">'/test/iloveyou'</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="p">{</span>
    <span class="s2">"destination"</span><span class="o">:</span> <span class="s2">"testing"</span><span class="p">,</span>
    <span class="s2">"params"</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">"variable"</span><span class="o">:</span> <span class="s2">"iloveyou"</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre>
</div>


<p>You can also generate routes from parameters if you give the route a name:</p>

<div class="highlight">
<pre><span class="nx">Router</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">'/test/:variable'</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="s1">'testing'</span><span class="p">).</span><span class="nx">name</span><span class="p">(</span><span class="s1">'testRoute'</span><span class="p">)</span>
<span class="nx">Router</span><span class="p">.</span><span class="nx">generate</span><span class="p">(</span><span class="s1">'testRoute'</span><span class="p">,</span> <span class="p">{</span> <span class="s2">"variable"</span><span class="o">:</span> <span class="s2">"iloveyou"</span> <span class="p">})</span> <span class="o">-&gt;</span>
  <span class="s2">"/test/iloveyou"</span>
</pre>
</div>


<h2>Using in JavascriptMVC</h2>

<p>First, grab a copy of the Sherpa library and put it in your resources directory. Then, in your JavascriptMVC project file you intialize Sherpa:</p>

<div class="highlight">
<pre><span class="nx">steal</span><span class="p">.</span><span class="nx">resources</span><span class="p">(</span><span class="s2">"sherpa"</span><span class="p">)</span>
     <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">Router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sherpa</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="p">});</span>
</pre>
</div>


<p>Now you have to choose how tightly you want to couple routes and controllers. I've approached this in a two different ways.</p>

<p>First, you can initialize a new controller on the document element when the route is matched:</p>

<div class="highlight">
<pre><span class="nx">Router</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">"/articles/:article_name"</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="s2">"project_article"</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">key</span>        <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="p">,</span>
    <span class="nx">foundRoute</span> <span class="o">=</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">recognize</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">foundRoute</span> <span class="o">&amp;&amp;</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">)[</span><span class="nx">foundRoute</span><span class="p">.</span><span class="nx">destination</span><span class="p">])</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">)[</span><span class="nx">foundRoute</span><span class="p">.</span><span class="nx">destination</span><span class="p">](</span><span class="nx">foundRoute</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
<span class="p">}</span>
</pre>
</div>


<p>Alternatively, you could fire an OpenAjax event instead:</p>

<div class="highlight">
<pre><span class="nx">Router</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">"/articles/:article_name"</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="s2">"project_article"</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">key</span>        <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="p">,</span>
    <span class="nx">foundRoute</span> <span class="o">=</span> <span class="nx">Router</span><span class="p">.</span><span class="nx">recognize</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">foundRoute</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">OpenAjax</span><span class="p">.</span><span class="nx">hub</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="nx">foundRoute</span><span class="p">.</span><span class="nx">destination</span><span class="p">,</span> <span class="nx">foundRoute</span><span class="p">.</span><span class="nx">params</span><span class="p">);</span>
<span class="p">}</span>
</pre>
</div>


<p>Unfortunately, this will only run once, during the inital load of your project. In reality, you will want to watch the location bar throughout the usage of your application and either run controllers or publish events for each location change. JavascriptMVC provides the <tt>jquery/controller/history</tt> which publishes <tt>history./current/url</tt> OpenAjax events when the location changes. You could wire this up on your own, or you could use the class we've developed and written tests for.</p>

<h2>SS.Router</h2>

<p>The Secondstory router class uses <tt>jquery/controller/history</tt> to listen to the location change events, then it matches against the Routes you have setup and finally sends a new OpenAjax event containing the value of the <tt>.to()</tt> method you setup when definition the route. It also contains logic for making sure multiple events aren't published for the same location if a user clicks the same link twice, for example.</p>

<p>First, grab the code using JavascriptMVC's built-in <tt>getjs</tt> command:</p>

<pre>./steal/js steal/getjs ss/router
</pre>

<p>So let's go back to our project configuration file:</p>

<div class="highlight">
<pre><span class="nx">steal</span><span class="p">.</span><span class="nx">plugins</span><span class="p">(</span><span class="s2">"ss/router"</span><span class="p">)</span>
     <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">Router</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">"/articles/:article_name"</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="s2">"project_article"</span><span class="p">);</span>
<span class="p">});</span>
</pre>
</div>


<p>That's it! When <tt>#/articles/my-first-article</tt> is accessed, OpenAjax will publish a <tt>project<em>article</em></tt> event with "my-first-article" as the "articlename" parameter.</p>

        </article><footer><p class="descr">My name is Thomas Reynolds. I'm a developer at <a href="http://weareinstrument.com">Instrument</a>, lucky denizen of Portland, active Crossfitter, a foodie, a cocktail enthusiast and all-around nerd.</p>
    
        <p>
          <a href="http://twitter.com/tdreyno">Twitter</a> â¢
          <a href="mailto:me@tdreyno.com">Email</a> â¢
          <a href="https://github.com/tdreyno">Github</a> â¢
          <a href="http://feeds2.feedburner.com/awf-allposts">RSS</a>
        </p>
      </footer>
</div>
    
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-90027-9']);
  _gaq.push(['_trackPageview']);
  _gaq.push(['_trackPageLoadTime']);

  (function() {
  var ga = document.createElement('script');
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 
    'http://www') + '.google-analytics.com/ga.js';
  ga.setAttribute('async', 'true');
  document.documentElement.firstChild.appendChild(ga);
  })();
</script><script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4d770721192b0c4ab6000002');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
</body>
</html>
